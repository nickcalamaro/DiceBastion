{{ define "main" }}
<article>
  <div id="event-detail-container">
    <div class="loading" style="text-align: center; padding: 3rem; color: rgba(var(--color-neutral-600), 1);">
      Loading event...
    </div>
  </div>
</article>

<style>
.event-detail {
  max-width: 800px;
  margin: 0 auto;
}

.event-header {
  margin-bottom: 2rem;
}

.event-hero-image {
  width: 100%;
  max-height: 400px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 1.5rem;
}

.event-title {
  font-size: 2.5rem;
  margin: 0 0 1rem 0;
  color: rgba(var(--color-neutral-800), 1);
}

.free-badge {
  display: inline-block;
  background: rgba(var(--color-success-100), 1);
  color: rgba(var(--color-success-700), 1);
  padding: 0.25rem 0.75rem;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

.event-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  margin: 1.5rem 0;
  padding: 1rem;
  background: rgba(var(--color-neutral-100), 1);
  border-radius: 8px;
}

.event-meta-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: rgba(var(--color-neutral-700), 1);
}

.event-meta-item strong {
  color: rgba(var(--color-neutral-900), 1);
}

.event-description {
  line-height: 1.8;
  color: rgba(var(--color-neutral-700), 1);
  margin: 2rem 0;
}

.event-description h1,
.event-description h2,
.event-description h3 {
  color: rgba(var(--color-neutral-900), 1);
  margin-top: 2rem;
  margin-bottom: 1rem;
}

.event-description ul,
.event-description ol {
  margin: 1rem 0;
  padding-left: 2rem;
}

.event-description a {
  color: rgba(var(--color-primary-600), 1);
  text-decoration: underline;
}

.error-message {
  text-align: center;
  padding: 3rem;
  color: rgba(var(--color-danger-600), 1);
}

@media (max-width: 768px) {
  .event-title {
    font-size: 2rem;
  }
  
  .event-meta {
    flex-direction: column;
    gap: 1rem;
  }
}
</style>

<script>
(function() {
  const API_BASE = 'https://dicebastion-memberships.ncalamaro.workers.dev';
  const TURNSTILE_SITE_KEY = '{{ site.Params.turnstile_site_key | default "0x4AAAAAACAB4xlOnW3S8K0k" }}';
  
  // Get slug from URL path
  const pathParts = window.location.pathname.split('/').filter(p => p);
  const slug = pathParts[pathParts.length - 1];
  
  if (!slug) {
    document.getElementById('event-detail-container').innerHTML = 
      '<div class="error-message">Event not found</div>';
    return;
  }
  
  async function loadEvent() {
    try {
      const res = await fetch(`${API_BASE}/events/${slug}`);
      
      if (!res.ok) {
        throw new Error('Event not found');
      }
      
      const data = await res.json();
      const event = data.event || data;
      
      const datetime = new Date(event.event_datetime);
      const isFree = event.requires_purchase !== 1;
      
      const dateStr = datetime.toLocaleDateString('en-GB', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const timeStr = datetime.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      let html = '<div class="event-detail">';
      html += '<div class="event-header">';
      
      if (event.image_url) {
        html += `<img src="${event.image_url}" alt="${event.title}" class="event-hero-image">`;
      }
      
      html += `<h1 class="event-title">${event.title}`;
      if (isFree) {
        html += '<span class="free-badge">Free Event</span>';
      }
      html += '</h1>';
      
      html += '<div class="event-meta">';
      html += `<div class="event-meta-item"><strong>üìÖ Date:</strong> ${dateStr}</div>`;
      html += `<div class="event-meta-item"><strong>üïí Time:</strong> ${timeStr}</div>`;
      if (event.location) {
        html += `<div class="event-meta-item"><strong>üìç Location:</strong> ${event.location}</div>`;
      }
      if (!isFree && event.capacity) {
        const available = event.capacity - (event.tickets_sold || 0);
        html += `<div class="event-meta-item"><strong>üé´ Spots Available:</strong> ${available} / ${event.capacity}</div>`;
      }
      html += '</div>'; // .event-meta
      
      html += '</div>'; // .event-header
      
      // Full description
      if (event.full_description) {
        html += `<div class="event-description">${event.full_description}</div>`;
      } else if (event.description) {
        html += `<div class="event-description"><p>${event.description}</p></div>`;
      }
      
      html += '</div>'; // .event-detail
      
      // Add eventPurchase component if requires purchase
      if (!isFree) {
        html += renderEventPurchase(event);
      }
      
      document.getElementById('event-detail-container').innerHTML = html;
      
      // If purchase component was added, initialize it
      if (!isFree) {
        initEventPurchase(event);
      }
      
    } catch (err) {
      console.error('Error loading event:', err);
      document.getElementById('event-detail-container').innerHTML = 
        '<div class="error-message">Event not found or failed to load</div>';
    }
  }
  
  function renderEventPurchase(event) {
    return `
      <div class="event-purchase my-6" data-event-id="${event.id || event.event_id}">
        <div class="event-ticket-box border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 bg-neutral dark:bg-neutral-800 shadow-lg max-w-xl opacity-100">
          <h3 class="mt-0 mb-2 text-xl font-bold text-primary-700 dark:text-primary-400">Get a Ticket</h3>
          <div class="event-prices flex gap-5 flex-wrap items-end mb-3">
            <div class="flex-1 min-w-[140px]">
              <div class="text-xs font-semibold uppercase text-neutral-600 dark:text-neutral-400 tracking-wide">Member Price</div>
              <div id="evt-member-price-${event.id || event.event_id}" class="text-2xl font-extrabold text-neutral-800 dark:text-neutral-200">¬£${event.membership_price}</div>
            </div>
            <div class="flex-1 min-w-[160px]">
              <div class="text-xs font-semibold uppercase text-neutral-600 dark:text-neutral-400 tracking-wide">Non‚ÄëMember Price</div>
              <div id="evt-nonmember-price-${event.id || event.event_id}" class="text-2xl font-extrabold text-neutral-800 dark:text-neutral-200">¬£${event.non_membership_price}</div>
            </div>
          </div>
          <p class="mt-0 mb-4 text-sm text-neutral-700 dark:text-neutral-300">Member discount is applied automatically if an active membership is found for your email.</p>
          <button type="button" class="evt-buy-btn w-full py-3 px-6 border-0 rounded-lg bg-primary-600 dark:bg-primary-500 text-neutral-50 text-base font-bold cursor-pointer shadow-md hover:bg-primary-700 dark:hover:bg-primary-600 transition-colors" data-event-id="${event.id || event.event_id}">Buy Ticket</button>
        </div>
        <div class="event-membership-promo mt-3 max-w-xl text-sm text-neutral-800 dark:text-neutral-200 bg-neutral-50 dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 py-3 px-4 rounded-lg opacity-100">
          <strong>Not a member yet?</strong> <span>Check out the list of benefits and sign up today!</span>
          <br>
          <a href="/memberships/" class="inline-block mt-2 py-1.5 px-4 font-semibold text-primary-700 dark:text-primary-400 bg-primary-50 dark:bg-primary-800/50 border border-primary-300 dark:border-primary-600 rounded-md hover:bg-primary-100 dark:hover:bg-primary-700/60 transition-colors">Become a member!</a>
        </div>
      </div>
      
      <div class="evt-modal" id="evt-modal-${event.id || event.event_id}" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
        <div class="evt-modal-inner bg-neutral dark:bg-neutral-800 rounded-xl p-5 relative shadow-2xl opacity-100" style="width:min(520px,95vw);">
          <button type="button" class="evt-close bg-transparent border-none text-2xl cursor-pointer text-neutral-700 dark:text-neutral-300" aria-label="Close" style="position:absolute; top:10px; right:10px;">√ó</button>
          <h3 class="mt-0 mb-3 text-lg font-bold text-neutral-800 dark:text-neutral-200">Ticket Checkout</h3>
          <div class="evt-step evt-details" style="display:block;">
            <label class="block mt-2 mb-1 font-semibold text-neutral-700 dark:text-neutral-300">Full name</label>
            <input type="text" class="evt-name w-full p-2.5 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-neutral dark:bg-neutral-700 text-neutral-800 dark:text-neutral-200" placeholder="Jane Doe">
            <label class="block mt-3 mb-1 font-semibold text-neutral-700 dark:text-neutral-300">Email</label>
            <input type="email" class="evt-email w-full p-2.5 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-neutral dark:bg-neutral-700 text-neutral-800 dark:text-neutral-200" placeholder="you@example.com">
            <div class="mt-3 flex gap-2 items-start text-sm leading-tight">
              <input type="checkbox" class="evt-privacy mt-1">
              <label class="text-neutral-700 dark:text-neutral-300">I agree to the <a href="/privacy-policy/" target="_blank" rel="noopener" class="text-primary-600 dark:text-primary-400 underline">Privacy Policy</a>.</label>
            </div>
            <div class="mt-3">
              <div class="text-sm text-neutral-700 dark:text-neutral-300 mb-2">Security check</div>
              <div id="evt-ts-${event.id || event.event_id}" class="cf-turnstile" data-sitekey="${TURNSTILE_SITE_KEY}" data-size="flexible"></div>
            </div>
            <button type="button" class="evt-continue mt-4 w-full py-3 border-none rounded-lg bg-primary-600 dark:bg-primary-500 text-neutral-50 font-bold cursor-pointer hover:bg-primary-700 dark:hover:bg-primary-600 transition-colors">Continue to Payment</button>
          </div>
          <div id="evt-card-${event.id || event.event_id}" class="evt-card mt-2" style="display:none;"></div>
          <div class="evt-error mt-2.5 text-sm font-semibold" style="display:none; color:#b00020;"></div>
          <div class="evt-success mt-4 py-3 px-4 rounded-lg font-semibold" style="display:none; background:#e9fbe9; border:1px solid #b9e8b9; color:#1a5d1a;">Ticket confirmed! See you there.</div>
        </div>
      </div>
    `;
  }
  
  function initEventPurchase(event) {
    const eventId = String(event.id || event.event_id);
    const root = document.querySelector('.event-purchase[data-event-id="'+eventId+'"]');
    const modal = document.getElementById('evt-modal-'+eventId);
    const cardEl = document.getElementById('evt-card-'+eventId);
    
    if (!root || !modal) return;
    
    function showError(msg){
      const el = modal.querySelector('.evt-error');
      if(!el) return;
      el.textContent = msg || 'Error';
      el.style.display='block';
    }
    
    function clearError(){
      const el = modal.querySelector('.evt-error');
      if(el){
        el.textContent='';
        el.style.display='none';
      }
    }
    
    function showSuccess(){
      const el = modal.querySelector('.evt-success');
      if(el){
        el.style.display='block';
      }
    }
    
    async function loadSumUpSdk(){
      if(window.SumUpCard) return true;
      return new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js';
        s.async=true;
        s.onload=()=>res(true);
        s.onerror=()=>rej(new Error('SumUp SDK load failed'));
        document.head.appendChild(s);
      });
    }
    
    function loadTurnstileSdk(){
      if (window.turnstile) return Promise.resolve(true);
      return new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://challenges.cloudflare.com/turnstile/v0/api.js';
        s.async=true;
        s.defer=true;
        s.onload=()=>res(true);
        s.onerror=()=>rej(new Error('Turnstile load failed'));
        document.head.appendChild(s);
      });
    }
    
    async function getTurnstileToken(){
      await loadTurnstileSdk();
      const tsEl = document.getElementById('evt-ts-'+eventId);
      if (!tsEl || !window.turnstile) throw new Error('Turnstile not ready');
      const token = window.turnstile.getResponse(tsEl);
      if (!token) throw new Error('Please complete the security check.');
      return token;
    }
    
    async function confirm(ref){
      const attempts=15;
      for(let i=0;i<attempts;i++){
        try {
          const r = await fetch(API_BASE + '/events/confirm?orderRef=' + encodeURIComponent(ref));
          const j = await r.json();
          if(j.ok && j.status==='active'){
            showSuccess();
            return true;
          }
          if(j.status && String(j.status).toUpperCase()==='PENDING'){
            await new Promise(r=>setTimeout(r,1500));
            continue;
          }
        } catch(e) {}
        await new Promise(r=>setTimeout(r,1500));
      }
      showError('Payment still processing. Refresh soon.');
      return false;
    }
    
    async function mountWidget(checkoutId, orderRef){
      try {
        await loadSumUpSdk();
      } catch(e){
        showError('Payment widget failed.');
        return;
      }
      
      try {
        clearError();
        cardEl.style.display='block';
        modal.querySelector('.evt-details').style.display='none';
        cardEl.innerHTML='';
        window.SumUpCard.mount({
          id: 'evt-card-'+eventId,
          checkoutId,
          onResponse: async (type) => {
            if(type && String(type).toLowerCase()==='success'){
              await confirm(orderRef);
            } else {
              showError('Payment failed');
            }
          }
        });
      } catch(e){
        showError('Could not start payment');
      }
    }
    
    function newIdempotencyKey(){
      try {
        return crypto.randomUUID();
      } catch {
        return String(Date.now()) + '-' + Math.random().toString(36).slice(2);
      }
    }
    
    async function startCheckout(email,name,privacy,turnstileToken){
      clearError();
      let resp;
      try {
        resp = await fetch(API_BASE + '/events/' + encodeURIComponent(eventId) + '/checkout', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Idempotency-Key': newIdempotencyKey()
          },
          body: JSON.stringify({
            email,
            name,
            privacyConsent: privacy,
            turnstileToken
          })
        });
      } catch(e){
        showError('Network error');
        return;
      }
      
      const data = await resp.json();
      if(!resp.ok){
        showError(data?.message || data?.error || 'Checkout failed');
        return;
      }
      
      if(data.checkoutId){
        mountWidget(data.checkoutId, data.orderRef);
        return;
      }
      
      showError('Missing checkout ID');
    }
    
    function openModal(){
      if(modal){
        modal.style.display='flex';
        const nameInput = modal.querySelector('.evt-name');
        if(nameInput) nameInput.focus();
        loadTurnstileSdk().catch(()=>{});
      }
    }
    
    function closeModal(){
      if(modal){
        modal.style.display='none';
        const d = modal.querySelector('.evt-details');
        if(d) d.style.display='block';
        if(cardEl){
          cardEl.innerHTML='';
          cardEl.style.display='none';
        }
        clearError();
        const s=modal.querySelector('.evt-success');
        if(s) s.style.display='none';
        modal.querySelector('.evt-name').value='';
        modal.querySelector('.evt-email').value='';
        modal.querySelector('.evt-privacy').checked=false;
        if (window.turnstile) {
          try {
            window.turnstile.reset('#evt-ts-'+eventId);
          } catch(_){}
        }
      }
    }
    
    root.querySelector('.evt-buy-btn')?.addEventListener('click', async () => {
      openModal();
    });
    
    modal.querySelector('.evt-close')?.addEventListener('click', closeModal);
    
    const contBtn = modal.querySelector('.evt-continue');
    contBtn && contBtn.addEventListener('click', async () => {
      const name = modal.querySelector('.evt-name').value.trim();
      const email = modal.querySelector('.evt-email').value.trim();
      const privacy = modal.querySelector('.evt-privacy').checked;
      
      if(!name){
        showError('Enter your full name');
        return;
      }
      if(!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
        showError('Enter a valid email');
        return;
      }
      if(!privacy){
        showError('Please agree to the Privacy Policy');
        return;
      }
      
      clearError();
      contBtn.disabled = true;
      
      let token;
      try {
        token = await getTurnstileToken();
      } catch(e){
        showError(e.message || 'Security check failed.');
        contBtn.disabled = false;
        return;
      }
      
      contBtn.disabled = false;
      startCheckout(email,name,privacy,token);
    });
    
    ['input','change'].forEach(ev => {
      ['.evt-name','.evt-email','.evt-privacy'].forEach(sel => {
        const el = modal.querySelector(sel);
        if(el) el.addEventListener(ev, clearError);
      });
    });
    
    const qs = new URLSearchParams(location.search);
    const ref = qs.get('orderRef');
    if(ref){
      confirm(ref).then(()=>{
        const u=new URL(location.href);
        u.searchParams.delete('orderRef');
        history.replaceState({},'',u);
      });
    }
  }
  
  loadEvent();
})();
</script>
{{ end }}
