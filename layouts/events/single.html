{{ define "main" }}
<!-- Load eventPurchase.js for event registration/purchase -->
<script src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>
<script src="/js/eventPurchase.js"></script>

<article>
  <div id="event-detail-container">
    <div class="loading" style="text-align: center; padding: 3rem; color: rgba(var(--color-neutral-600), 1);">
      Loading event...
    </div>
  </div>
</article>

<style>
.event-detail {
  max-width: 800px;
  margin: 0 auto;
}

.event-header {
  margin-bottom: 2rem;
}

.event-hero-image {
  width: 100%;
  max-height: 400px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 1.5rem;
}

.event-title {
  font-size: 2.5rem;
  margin: 0 0 1rem 0;
  color: rgba(var(--color-neutral-800), 1);
}

.free-badge {
  display: inline-block;
  background: rgba(var(--color-success-100), 1);
  color: rgba(var(--color-success-700), 1);
  padding: 0.25rem 0.75rem;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

.event-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  margin: 1.5rem 0;
  padding: 1rem;
  background: rgba(var(--color-neutral-100), 1);
  border-radius: 8px;
}

.event-meta-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: rgba(var(--color-neutral-700), 1);
}

.event-meta-item strong {
  color: rgba(var(--color-neutral-900), 1);
}

.event-description {
  line-height: 1.8;
  color: rgba(var(--color-neutral-700), 1);
  margin: 2rem 0;
}

.event-description h1,
.event-description h2,
.event-description h3 {
  color: rgba(var(--color-neutral-900), 1);
  margin-top: 2rem;
  margin-bottom: 1rem;
}

.event-description ul,
.event-description ol {
  margin: 1rem 0;
  padding-left: 2rem;
}

.event-description a {
  color: rgba(var(--color-primary-600), 1);
  text-decoration: underline;
}

.error-message {
  text-align: center;
  padding: 3rem;
  color: rgba(var(--color-danger-600), 1);
}

@media (max-width: 768px) {
  .event-title {
    font-size: 2rem;
  }
  
  .event-meta {
    flex-direction: column;
    gap: 1rem;
  }
}
</style>

<script>
(function() {
  const API_BASE = 'https://dicebastion-memberships.ncalamaro.workers.dev';
  const TURNSTILE_SITE_KEY = '{{ site.Params.turnstile_site_key | default "0x4AAAAAACAB4xlOnW3S8K0k" }}';
  
  // Get slug from URL path
  const pathParts = window.location.pathname.split('/').filter(p => p);
  const slug = pathParts[pathParts.length - 1];
  
  if (!slug) {
    document.getElementById('event-detail-container').innerHTML = 
      '<div class="error-message">Event not found</div>';
    return;
  }
  
  async function loadEvent() {
    try {
      const res = await fetch(`${API_BASE}/events/${slug}`);
      
      if (!res.ok) {
        throw new Error('Event not found');
      }
      
      const data = await res.json();
      const event = data.event || data;
      
      const datetime = new Date(event.event_datetime);
      const isFree = event.requires_purchase !== 1;
      
      const dateStr = datetime.toLocaleDateString('en-GB', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const timeStr = datetime.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      let html = '<div class="event-detail">';
      html += '<div class="event-header">';
      
      if (event.image_url) {
        html += `<img src="${event.image_url}" alt="${event.title}" class="event-hero-image">`;
      }
      
      html += `<h1 class="event-title">${event.title}`;
      if (isFree) {
        html += '<span class="free-badge">Free Event</span>';
      }
      html += '</h1>';
      
      html += '<div class="event-meta">';
      html += `<div class="event-meta-item"><strong>üìÖ Date:</strong> ${dateStr}</div>`;
      html += `<div class="event-meta-item"><strong>üïí Time:</strong> ${timeStr}</div>`;
      if (event.location) {
        html += `<div class="event-meta-item"><strong>üìç Location:</strong> ${event.location}</div>`;
      }
      if (!isFree && event.capacity) {
        const available = event.capacity - (event.tickets_sold || 0);
        html += `<div class="event-meta-item"><strong>üé´ Spots Available:</strong> ${available} / ${event.capacity}</div>`;
      }
      html += '</div>'; // .event-meta
        html += '</div>'; // .event-header
      
      // Full description
      if (event.full_description) {
        html += `<div class="event-description">${event.full_description}</div>`;
      } else if (event.description) {
        html += `<div class="event-description"><p>${event.description}</p></div>`;
      }
      html += '</div>'; // .event-detail
        document.getElementById('event-detail-container').innerHTML = html;
      
      console.log('Event loaded:', event);
      console.log('renderEventPurchase available?', typeof renderEventPurchase);
      console.log('initEventPurchase available?', typeof initEventPurchase);
      
      // Wait for eventPurchase.js to load, then add the component
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds
      
      const checkInterval = setInterval(() => {
        attempts++;
        
        if (typeof renderEventPurchase === 'function' && typeof initEventPurchase === 'function') {
          clearInterval(checkInterval);
          console.log('‚úÖ Functions found! Adding purchase/registration UI...');
          
          try {
            const purchaseHtml = renderEventPurchase(event);
            console.log('Purchase HTML generated:', purchaseHtml.substring(0, 200));
            document.getElementById('event-detail-container').insertAdjacentHTML('beforeend', purchaseHtml);
            initEventPurchase(event);
            console.log('‚úÖ UI initialized successfully');
          } catch (error) {
            console.error('‚ùå Error initializing purchase UI:', error);
          }
        } else if (attempts >= maxAttempts) {
          clearInterval(checkInterval);          console.error('‚ùå Timeout: eventPurchase.js functions not found after 5 seconds');
          console.log('Available window functions:', Object.keys(window).filter(k => k.includes('event') || k.includes('Event')));
        }
      }, 100);
      
    } catch (err) {
      console.error('Error loading event:', err);
      document.getElementById('event-detail-container').innerHTML = 
        '<div class="error-message">Event not found or failed to load</div>';
    }
  }
  
  loadEvent();
})();
</script>
{{ end }}
