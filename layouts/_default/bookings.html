{{ define "main" }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

<style>
/* Table type selection using responsive grid pattern */
.table-types-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}

.table-type-card {
  background: linear-gradient(180deg, #ffffff, #f9f9f9);
  border: 1px solid rgb(var(--color-neutral-300));
  border-radius: 12px;
  padding: 1.5rem;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
  display: flex;
  flex-direction: column;
}

.dark .table-type-card {
  background: linear-gradient(180deg, rgb(var(--color-neutral-800)), rgb(var(--color-neutral-900)));
  border-color: rgb(var(--color-neutral-700));
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3);
}

.table-type-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  border-color: rgb(var(--color-primary-500));
}

.table-type-card.selected {
  border: 2px solid rgb(var(--color-primary-600));
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
  background: linear-gradient(135deg, rgb(var(--color-primary-50)), white);
}

.dark .table-type-card.selected {
  background: linear-gradient(135deg, rgba(var(--color-primary-900), 0.3), rgb(var(--color-neutral-800)));
  border-color: rgb(var(--color-primary-400));
}

.table-type-name {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  color: rgb(var(--color-neutral-900));
  line-height: 1.3;
  word-wrap: break-word;
}

.dark .table-type-name {
  color: rgb(var(--color-neutral-50));
}

.table-type-price {
  font-size: 1.7rem;
  font-weight: 800;
  color: rgb(var(--color-primary-600));
  margin: 0.5rem 0;
}

.table-type-price.free {
  color: rgb(var(--color-success-600));
}

.table-type-description {
  color: rgb(var(--color-neutral-600));
  font-size: 0.95rem;
  margin-top: 0.5rem;
  line-height: 1.6;
}

.table-type-note {
  margin-top: 1rem;
  padding: 0.5rem;
  background: rgba(var(--color-warning-500), 0.1);
  border-radius: 6px;
  font-size: 0.85rem;
  color: rgb(var(--color-warning-700));
}

/* Time slots grid */
.slots-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 0.75rem;
  margin: 1.5rem 0;
}

.slot-btn {
  padding: 1rem;
  border: 1px solid rgb(var(--color-neutral-300));
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 600;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.dark .slot-btn {
  background: rgb(var(--color-neutral-800));
  border-color: rgb(var(--color-neutral-700));
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.slot-btn:hover {
  border-color: rgb(var(--color-primary-500));
  background: rgb(var(--color-primary-50));
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.dark .slot-btn:hover {
  background: rgb(var(--color-neutral-700));
}

.slot-btn.selected {
  border: 2px solid rgb(var(--color-primary-600));
  background: linear-gradient(135deg, rgb(var(--color-primary-500)), rgb(var(--color-primary-600)));
  color: white;
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.slot-btn:disabled {
  background: rgb(var(--color-neutral-100));
  color: rgb(var(--color-neutral-400));
  cursor: not-allowed;
  border-color: rgb(var(--color-neutral-200));
  box-shadow: none;
}

.dark .slot-btn:disabled {
  background: rgb(var(--color-neutral-900));
}

/* Booking items list */
.booking-item {
  padding: 1.25rem;
  border-left: 4px solid rgb(var(--color-primary-600));
  background: linear-gradient(90deg, rgb(var(--color-primary-50)), white);
  margin-bottom: 0.75rem;
  border-radius: 8px;
}

.dark .booking-item {
  background: linear-gradient(90deg, rgb(var(--color-neutral-800)), rgb(var(--color-neutral-900)));
}

.booking-time {
  font-weight: 700;
  color: rgb(var(--color-primary-700));
  margin-bottom: 0.25rem;
}

/* Hero image */
.hero-image {
  text-align: center;
  margin: 1rem 0 2rem;
}

.hero-image img {
  max-width: 100%;
  height: auto;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

/* Loading state */
.loading {
  text-align: center;
  padding: 3rem;
  color: rgb(var(--color-neutral-600));
}

.dark .loading {
  color: rgb(var(--color-neutral-400));
}

/* Membership upsell banner */
.membership-upsell {
  background: linear-gradient(135deg, rgb(var(--color-primary-500)), rgb(var(--color-primary-600)));
  color: white;
  padding: 1.5rem;
  border-radius: 12px;
  margin-bottom: 1.5rem;
  text-align: center;
}

.membership-upsell-title {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

/* Mobile responsive */
@media (max-width: 640px) {
  .table-types-grid,
  .slots-grid {
    grid-template-columns: 1fr;
  }
  
  .table-type-card {
    padding: 1.25rem;
  }
  
  .table-type-name {
    font-size: 1.1rem;
  }
  
  .table-type-price {
    font-size: 1.5rem;
  }
  
  .hero-image {
    margin: 0.5rem 0 1.5rem;
  }
}
</style>

<div class="page-container">
  <h1 class="hero-cta-title" style="text-align: center; margin-bottom: 1rem; color: rgb(var(--color-primary-600));">{{ .Title }}</h1>
  
  {{ if .Params.image }}
  <div class="hero-image">
    <img src="{{ .Params.image }}" alt="Gaming table">
  </div>
  {{ end }}

  <div id="alert-container"></div>
  
  <div id="membership-status-container"></div>

  <!-- Table Type Selection -->
  <h2 class="card-header" style="margin: 2rem 0 0.5rem;">Select Table Type</h2>
  <div id="table-types-container" class="loading">Loading table types...</div>

  <!-- Date Selection Card -->
  <div class="card" id="date-section" style="margin-top: 2rem; opacity: 0.5; pointer-events: none;">
    <h2 class="card-header">üìÖ Choose a Date</h2>
    <div id="date-instruction" style="padding: 1rem; text-align: center; color: rgb(var(--color-neutral-600)); font-size: 0.95rem;">
      Please select a table type first
    </div>
    <div class="form-group" style="margin-bottom: 0; display: none;" id="date-input-wrapper">
      <input type="text" id="booking-date" class="form-input" placeholder="Choose a date..." readonly>
    </div>
  </div>

  <!-- Available Slots Card -->
  <div class="card" id="slots-section" style="margin-top: 2rem; opacity: 0.5; pointer-events: none;">
    <h2 class="card-header">‚è∞ Available Time Slots</h2>
    <div id="slots-instruction" style="padding: 1rem; text-align: center; color: rgb(var(--color-neutral-600)); font-size: 0.95rem;">
      Please choose a date first
    </div>
    <div id="slots-container" style="display: none;"></div>
  </div>

  <!-- Booking Form Card -->
  <div class="card" id="booking-form-section" style="margin-top: 2rem; opacity: 0.5; pointer-events: none;">
    <h2 class="card-header">‚úçÔ∏è Complete Your Booking</h2>
    
    <div id="booking-form-instruction" style="padding: 1rem; text-align: center; color: rgb(var(--color-neutral-600)); font-size: 0.95rem;">
      Please select a time slot first
    </div>
    
    <div id="booking-form-wrapper" style="display: none;">
      <div id="membership-upsell-container"></div>
      
      <form id="booking-form">
        <div id="selected-details"></div>

        <div class="form-group">
          <label for="user-name" class="form-label">Your Name *</label>
          <input type="text" id="user-name" class="form-input" placeholder="John Smith" required>
        </div>

        <div class="form-group">
          <label for="user-email" class="form-label">Email Address *</label>
          <input type="email" id="user-email" class="form-input" placeholder="john@example.com" required>
        </div>

        <div class="form-group">
          <label for="notes" class="form-label">Notes (Optional)</label>
          <textarea id="notes" class="form-textarea" rows="3" placeholder="Any special requirements or requests..."></textarea>
        </div>

      <div id="turnstile-container" class="form-group"></div>

      <button type="submit" id="submit-btn" class="btn btn-primary btn-full btn-lg">
        <span id="submit-text">‚úì Confirm Booking</span>
      </button>
    </form>
    </div>
    <h2 class="card-header">üìã Your Bookings</h2>
    <div id="bookings-container" class="loading">Loading bookings</div>
  </div>
</div>

<!-- Payment Modal Container -->
<div id="payment-modal-container"></div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="/js/utils.js"></script>
<script src="/js/modal.js"></script>
<script src="/js/auth-modal.js"></script>
<script>
// API endpoints
const BOOKINGS_API = 'https://dicebastionbookings-ofbbu.bunny.run'; // Bunny Edge Script
const PAYMENTS_API = 'https://payments.dicebastion.workers.dev'; // Cloudflare Payments Worker
const MAIN_API = 'https://dicebastion-memberships.ncalamaro.workers.dev'; // Main worker
const TS_SITE_KEY = '0x4AAAAAACAB4xlOnW3S8K0k';
const IS_LOCALHOST = window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1';

let tableTypes = [];
let selectedTableType = null;
let selectedSlot = null;
let currentDate = null;
let picker = null;
let userSession = null;
let membershipStatus = null;
let paymentModal = null;
let authModal = null;

document.addEventListener('DOMContentLoaded', async () => {
  // Initialize auth modal
  authModal = new AuthModal({
    mainApiUrl: MAIN_API,
    onSuccess: async (type, user) => {
      console.log(`${type} successful:`, user);
      userSession = user;
      
      // Reload membership status and table types to update pricing
      await checkMembershipStatus();
      await loadTableTypes();
      
      // Pre-fill user details in form if visible
      if (userSession) {
        document.getElementById('user-email').value = userSession.email || '';
        document.getElementById('user-name').value = userSession.name || '';
      }
    }
  });
  
  // Make auth modal globally available for footer login button
  window.authModal = authModal;
  
  // Check user session
  userSession = utils.session.getUser();
  if (userSession) {
    document.getElementById('user-email').value = userSession.email || '';
    document.getElementById('user-name').value = userSession.name || '';
  }
  
  // Check membership status
  await checkMembershipStatus();
  
  // Load table types
  await loadTableTypes();
  
  // Load user's bookings
  await loadBookingsForDate();
  
  document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);
});

/**
 * Check if user is a current member
 */
async function checkMembershipStatus() {
  if (!userSession || !userSession.email) {
    membershipStatus = null;
    return;
  }

  try {
    const response = await fetch(`${MAIN_API}/membership/status?email=${encodeURIComponent(userSession.email)}`);
    if (response.ok) {
      const data = await response.json();
      membershipStatus = data;
    } else {
      console.error('Failed to fetch membership status');
      membershipStatus = null;
    }
  } catch (error) {
    console.error('Error checking membership:', error);
    membershipStatus = null;
  }
}

async function loadTableTypes() {
  const container = document.getElementById('table-types-container');
  
  // Show auth prompt for non-logged-in users at the top
  const statusContainer = document.getElementById('membership-status-container');
  if (!userSession) {
    statusContainer.innerHTML = `
      <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, rgba(var(--color-primary-50), 0.5), rgba(var(--color-primary-100), 0.3));">
        <div class="card-body">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
              <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; color: rgb(var(--color-neutral-900));">
                üí° Have an account?
              </h3>
              <p style="margin: 0; color: rgb(var(--color-neutral-700)); font-size: 0.95rem;">
                Login or register to get membership discounts and save your booking history.
              </p>
            </div>
            <button type="button" class="btn btn-primary" onclick="authModal.show()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Login / Register
            </button>
          </div>
        </div>
      </div>
    `;
  } else if (membershipStatus?.active) {
    statusContainer.innerHTML = `
      <div class="alert alert-success" style="margin-bottom: 1.5rem;">
        ‚úì You're getting free bookings as a GWC Member. Thank you for your support!
      </div>
    `;
  }
  
  try {
    const response = await fetch(`${BOOKINGS_API}/api/bookings/table-types`);
    const data = await response.json();
    tableTypes = data.table_types || [];
    
    if (tableTypes.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No table types available</div>';
      return;
    }
    
    const grid = document.createElement('div');
    grid.className = 'table-types-grid';
    
    tableTypes.forEach(type => {
      const isMember = membershipStatus?.active || false;
      const price = isMember ? type.member_price : type.non_member_price;
      
      const card = document.createElement('div');
      card.className = 'table-type-card';
      card.innerHTML = `
        <div class="table-type-name">${type.name}</div>
        <div class="table-type-price ${price === 0 ? 'free' : ''}">
          ${price === 0 ? 'FREE' : `¬£${price.toFixed(2)}`}
        </div>
        ${type.description ? `<div class="table-type-description">${type.description}</div>` : ''}
        ${!isMember && type.member_price < type.non_member_price ? `
          <div class="table-type-note">
            üí° ${type.member_price === 0 ? 'Free for members' : `Members pay only ¬£${type.member_price.toFixed(2)}`}
          </div>
        ` : ''}
      `;
      
      card.addEventListener('click', () => selectTableType(type, card));
      grid.appendChild(card);
    });
    
    container.innerHTML = '';
    container.appendChild(grid);
    
    // Show membership promo if not logged in or not a member
    if (!userSession || !membershipStatus?.active) {
      const promoDiv = document.createElement('div');
      promoDiv.style.cssText = 'margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--color-primary-500), 0.1), rgba(var(--color-primary-600), 0.05)); border-radius: 12px; text-align: center; border: 2px solid rgba(var(--color-primary-500), 0.3);';
      promoDiv.innerHTML = `
        <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.75rem; color: rgb(var(--color-primary-700));">
          üíé Want free table bookings?
        </div>
        <p style="margin: 0 0 1rem 0; color: rgb(var(--color-neutral-700)); font-size: 1rem;">
          Sign up now as a member for as low as ¬£7.50 / month*
        </p>
        <a href="/memberships" class="btn btn-primary" style="display: inline-block;">
          View Membership Options ‚Üí
        </a>
        <div style="margin-top: 0.75rem; font-size: 0.85rem; color: rgb(var(--color-neutral-600)); font-style: italic;">
          * based on an annual membership
        </div>
      `;
      container.appendChild(promoDiv);
    }
    
  } catch (error) {
    console.error('Error loading table types:', error);
    container.innerHTML = '<div class="alert alert-error">Failed to load table types</div>';
  }
}

function selectTableType(type, cardElement) {
  document.querySelectorAll('.table-type-card').forEach(c => c.classList.remove('selected'));
  cardElement.classList.add('selected');
  selectedTableType = type;
  
  // Activate date section
  const dateSection = document.getElementById('date-section');
  dateSection.style.opacity = '1';
  dateSection.style.pointerEvents = 'auto';
  document.getElementById('date-instruction').style.display = 'none';
  document.getElementById('date-input-wrapper').style.display = 'block';
  
  // Scroll to date section
  setTimeout(() => {
    dateSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
  
  // Initialize Flatpickr if not already done
  if (!picker) {
    const today = new Date();
    
    // Parse available days (day names like "Monday", "Tuesday", etc.)
    const availableDays = Array.isArray(type.available_days) ? type.available_days : [];
    const dayMap = { 'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6 };
    const enabledDays = availableDays.map(day => dayMap[day]).filter(d => d !== undefined);
    
    picker = flatpickr('#booking-date', {
      minDate: 'today',
      dateFormat: 'Y-m-d',
      enable: [
        function(date) {
          return enabledDays.includes(date.getDay());
        }
      ],
      onChange: (selectedDates, dateStr) => {
        handleDateChange(dateStr);
      }
    });
  } else {
    // Update enable function for new table type
    const availableDays = Array.isArray(type.available_days) ? type.available_days : [];
    const dayMap = { 'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6 };
    const enabledDays = availableDays.map(day => dayMap[day]).filter(d => d !== undefined);
    
    picker.set('enable', [
      function(date) {
        return enabledDays.includes(date.getDay());
      }
    ]);
  }
}

async function handleDateChange(date) {
  if (!date || !selectedTableType) return;
  
  currentDate = date;
  selectedSlot = null;
  
  // Reset booking form to disabled state
  const formSection = document.getElementById('booking-form-section');
  formSection.style.opacity = '0.5';
  formSection.style.pointerEvents = 'none';
  document.getElementById('booking-form-instruction').style.display = 'block';
  document.getElementById('booking-form-wrapper').style.display = 'none';
  
  await loadAvailableSlots(date);
  
  // Scroll to slots section
  setTimeout(() => {
    document.getElementById('slots-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

async function loadAvailableSlots(date) {
  const container = document.getElementById('slots-container');
  const slotsSection = document.getElementById('slots-section');
  const slotsInstruction = document.getElementById('slots-instruction');
  
  // Activate slots section
  slotsSection.style.opacity = '1';
  slotsSection.style.pointerEvents = 'auto';
  slotsInstruction.style.display = 'none';
  container.style.display = 'block';
  
  container.innerHTML = '<div class="loading">Generating time slots</div>';
  
  try {
    // Generate standard time slots (10:00 - 22:00, 4-hour slots)
    const slots = [];
    for (let hour = 10; hour <= 18; hour += 4) {
      const startTime = `${String(hour).padStart(2, '0')}:00`;
      const endTime = `${String(hour + 4).padStart(2, '0')}:00`;
      slots.push({ startTime, endTime });
    }
    
    if (slots.length === 0) {
      container.innerHTML = '<div class="alert alert-info">üì≠ No available slots</div>';
      return;
    }
    
    const grid = document.createElement('div');
    grid.className = 'slots-grid';
    
    slots.forEach(slot => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'slot-btn';
      btn.innerHTML = `<div style="font-size: 1.1rem;">‚è∞</div><div>${slot.startTime}</div><div style="font-size: 0.8rem; opacity: 0.7;">to ${slot.endTime}</div>`;
      btn.onclick = () => selectSlot(slot, btn);
      grid.appendChild(btn);
    });
    
    container.innerHTML = '';
    container.appendChild(grid);
    
  } catch (error) {
    console.error('Error loading slots:', error);
    container.innerHTML = '<div class="alert alert-error">‚ö†Ô∏è Failed to load available slots</div>';
  }
}

function selectSlot(slot, btnElement) {
  document.querySelectorAll('.slot-btn').forEach(btn => btn.classList.remove('selected'));
  btnElement.classList.add('selected');
  selectedSlot = slot;
  
  const formSection = document.getElementById('booking-form-section');
  
  // Activate booking form section
  formSection.style.opacity = '1';
  formSection.style.pointerEvents = 'auto';
  document.getElementById('booking-form-instruction').style.display = 'none';
  document.getElementById('booking-form-wrapper').style.display = 'block';
  
  const isMember = membershipStatus?.active || false;
  const price = isMember ? selectedTableType.member_price : selectedTableType.non_member_price;
  
  document.getElementById('selected-details').innerHTML = `
    <div class="alert alert-success" style="font-size: 1.1rem;">
      <strong>‚úì Selected:</strong><br>
      ${selectedTableType.name}<br>
      ${currentDate} at ${slot.startTime}<br>
      <strong>Price: ${price === 0 ? 'FREE' : `¬£${price.toFixed(2)}`}</strong>
    </div>
  `;
  
  // Clear any previous membership upsell
  document.getElementById('membership-upsell-container').innerHTML = '';
  
  // Pre-fill email if logged in
  if (userSession?.email) {
    document.getElementById('user-email').value = userSession.email;
    document.getElementById('user-name').value = userSession.name || '';
  }
  
  // Render Turnstile
  setTimeout(() => {
    utils.renderTurnstile('turnstile-container', TS_SITE_KEY, { skipOnLocalhost: IS_LOCALHOST });
  }, 100);
  
  // Scroll to booking form
  setTimeout(() => {
    formSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 100);
}

async function handleBookingSubmit(e) {
  e.preventDefault();
  
  if (!selectedTableType || !selectedSlot || !currentDate) {
    showAlert('‚ö†Ô∏è Please select a table type, date and time slot', 'error');
    return;
  }
  
  const userEmail = document.getElementById('user-email').value.trim();
  const userName = document.getElementById('user-name').value.trim();
  const notes = document.getElementById('notes').value.trim();
  
  if (!userName || !userEmail) {
    showAlert('‚ö†Ô∏è Please enter your name and email', 'error');
    return;
  }
  
  const submitBtn = document.getElementById('submit-btn');
  const submitText = document.getElementById('submit-text');
  submitBtn.disabled = true;
  submitText.textContent = '‚è≥ Processing...';
  
  try {
    const turnstileToken = await utils.getTurnstileToken('turnstile-container', null, IS_LOCALHOST);
    
    const isMember = membershipStatus?.active || false;
    const price = isMember ? selectedTableType.member_price : selectedTableType.non_member_price;
    const orderRef = `BOOK-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    // Create booking in Bunny database
    const bookingResponse = await fetch(`${BOOKINGS_API}/api/bookings`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_email: userEmail,
        user_name: userName,
        booking_date: currentDate,
        start_time: selectedSlot.startTime,
        end_time: selectedSlot.endTime,
        table_type_id: selectedTableType.id,
        order_ref: orderRef,
        amount_paid: price,
        is_member_booking: isMember,
        notes: notes || null
      })
    });
    
    const bookingData = await bookingResponse.json();
    
    if (!bookingResponse.ok) {
      console.error('Booking creation failed:', bookingResponse.status, bookingData);
      throw new Error(bookingData.error || bookingData.details || 'Booking creation failed');
    }
    
    // If free booking, it's already confirmed
    if (price === 0) {
      showAlert('‚úÖ Booking confirmed!', 'success');
      document.getElementById('booking-form').reset();
      document.getElementById('booking-form-section').classList.add('hidden');
      selectedTableType = null;
      selectedSlot = null;
      await loadBookingsForDate();
      return;
    }
    
    // Create payment checkout via Payments Worker
    const checkoutResponse = await fetch(`${PAYMENTS_API}/internal/checkout`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-Internal-Secret': 'your-internal-secret' // TODO: Get from config
      },
      body: JSON.stringify({
        amount: price,
        currency: 'GBP',
        orderRef: orderRef,
        description: `${selectedTableType.name} - ${currentDate} ${selectedSlot.startTime}`
      })
    });
    
    const checkoutData = await checkoutResponse.json();
    
    if (!checkoutResponse.ok) {
      throw new Error(checkoutData.error || 'Payment checkout failed');
    }
    
    // Show payment modal
    await showPaymentModal(checkoutData.id, orderRef, price);
    
  } catch (error) {
    console.error('Error creating booking:', error);
    showAlert('‚ö†Ô∏è ' + error.message, 'error');
  } finally {
    submitBtn.disabled = false;
    submitText.textContent = '‚úì Confirm Booking';
  }
}

async function showPaymentModal(checkoutId, orderRef, amount) {
  await utils.loadSumUpSdk();
  
  paymentModal = new Modal({
    title: 'Complete Payment',
    size: 'md',
    closeOnBackdrop: false,
    content: `
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <div style="font-size: 2rem; font-weight: 800; color: rgb(var(--color-primary-600));">¬£${amount.toFixed(2)}</div>
        <div style="color: rgb(var(--color-neutral-600));">${selectedTableType.name} - ${currentDate}</div>
      </div>
      <div id="sumup-card-container"></div>
      <div id="payment-error" class="alert alert-error" style="display: none; margin-top: 1rem;"></div>
    `,
    onClose: () => { paymentModal = null; }
  });
  
  paymentModal.open();
  
  window.SumUpCard.mount({
    id: 'sumup-card-container',
    checkoutId,
    onResponse: async (type) => {
      if (type === 'success') {
        await confirmBooking(orderRef);
      } else if (type === 'error' || type === 'fail') {
        document.getElementById('payment-error').textContent = 'Payment failed. Please try again.';
        document.getElementById('payment-error').style.display = 'block';
      }
    }
  });
}

async function confirmBooking(orderRef) {
  const result = await utils.pollPaymentConfirmation(`${BOOKINGS_API}/api/bookings/confirm/${orderRef}`, null, {
    pollInterval: 3000,
    maxAttempts: 20,
    onSuccess: (data) => {
      if (paymentModal) paymentModal.close();
      showAlert('‚úÖ Booking confirmed! Check your email for details.', 'success');
      document.getElementById('booking-form').reset();
      document.getElementById('booking-form-section').classList.add('hidden');
      selectedTableType = null;
      selectedSlot = null;
      loadBookingsForDate();
    },
    onError: (errorMsg) => {
      if (paymentModal) {
        document.getElementById('payment-error').textContent = errorMsg;
        document.getElementById('payment-error').style.display = 'block';
      }
    },
    onTimeout: () => {
      if (paymentModal) paymentModal.close();
      showAlert('‚è≥ Payment is being processed. Check your email for confirmation.', 'info');
    }
  });
}

async function loadBookingsForDate(date) {
  const container = document.getElementById('bookings-container');
  
  // Only show user's bookings if logged in
  if (!userSession?.email) {
    container.innerHTML = '<div class="alert alert-info">üìã Log in to see your bookings</div>';
    return;
  }
  
  container.innerHTML = '<div class="loading">Loading your bookings</div>';
  
  try {
    const response = await fetch(`${BOOKINGS_API}/api/bookings/user/${encodeURIComponent(userSession.email)}`);
    const data = await response.json();
    
    if (!data.bookings || data.bookings.length === 0) {
      container.innerHTML = '<div class="alert alert-info">üì≠ You have no upcoming bookings</div>';
      return;
    }
    
    const list = document.createElement('div');
    data.bookings.forEach(booking => {
      const item = document.createElement('div');
      item.className = 'booking-item';
      const statusBadge = booking.status === 'confirmed' ? '‚úÖ' : '‚è≥';
      item.innerHTML = `
        <div class="booking-time">‚è∞ ${booking.booking_date} ${booking.start_time} - ${booking.end_time}</div>
        <div>üé≤ ${booking.table_type} ${statusBadge}</div>
      `;
      list.appendChild(item);
    });
    
    container.innerHTML = '<h3 style="margin: 0 0 1rem 0; font-size: 1.1rem;">Your Bookings</h3>';
    container.appendChild(list);
    
  } catch (error) {
    console.error('Error loading bookings:', error);
    container.innerHTML = '<div class="alert alert-error">‚ö†Ô∏è Failed to load bookings</div>';
  }
}

function showAlert(message, type = 'info') {
  const container = document.getElementById('alert-container');
  const alert = document.createElement('div');
  alert.className = `alert alert-${type}`;
  alert.textContent = message;
  
  container.innerHTML = '';
  container.appendChild(alert);
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  setTimeout(() => {
    alert.style.opacity = '0';
    alert.style.transition = 'opacity 0.3s';
    setTimeout(() => alert.remove(), 300);
  }, 5000);
}
</script>
{{ end }}
