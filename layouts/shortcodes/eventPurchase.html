{{/* eventPurchase shortcode: usage: {{< eventPurchase id="123" sitekey="YOUR_TURNSTILE_SITE_KEY" >}} */}}
<!-- Renders a ticket purchase button + modal using SumUp in-page widget -->
<!-- Requires worker endpoints /events/:id, /events/:id/checkout, /events/confirm -->

<div class="event-purchase my-6" data-event-id="{{ .Get "id" }}">
  <div class="event-ticket-box border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 bg-neutral dark:bg-neutral-800 shadow-lg max-w-xl opacity-100">
    <h3 class="mt-0 mb-2 text-xl font-bold text-primary-700 dark:text-primary-400">Get a Ticket</h3>
    <div class="event-prices flex gap-5 flex-wrap items-end mb-3">
      <div class="flex-1 min-w-[140px]">
        <div class="text-xs font-semibold uppercase text-neutral-600 dark:text-neutral-400 tracking-wide">Member Price</div>
        <div id="evt-member-price-{{ .Get "id" }}" class="text-2xl font-extrabold text-neutral-800 dark:text-neutral-200">â€“</div>
      </div>
      <div class="flex-1 min-w-[160px]">
        <div class="text-xs font-semibold uppercase text-neutral-600 dark:text-neutral-400 tracking-wide">Nonâ€‘Member Price</div>
        <div id="evt-nonmember-price-{{ .Get "id" }}" class="text-2xl font-extrabold text-neutral-800 dark:text-neutral-200">â€“</div>
      </div>
    </div>
    <p class="mt-0 mb-4 text-sm text-neutral-700 dark:text-neutral-300">Member discount is applied automatically if an active membership is found for your email.</p>
    <button type="button" class="evt-buy-btn w-full py-3 px-6 border-0 rounded-lg bg-primary-600 dark:bg-primary-500 text-neutral-50 text-base font-bold cursor-pointer shadow-md hover:bg-primary-700 dark:hover:bg-primary-600 transition-colors" data-event-id="{{ .Get "id" }}">Buy Ticket</button>
  </div>
  <!-- New membership promo block -->
  <div class="event-membership-promo mt-3 max-w-xl text-sm text-neutral-800 dark:text-neutral-200 bg-neutral-50 dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 py-3 px-4 rounded-lg opacity-100">
    <strong>Not a member yet?</strong> <span>Check out the list of benefits and sign up today!</span>
    <br>
    <a href="/memberships/" class="inline-block mt-2 py-1.5 px-4 font-semibold text-primary-700 dark:text-primary-400 bg-primary-50 dark:bg-primary-800/50 border border-primary-300 dark:border-primary-600 rounded-md hover:bg-primary-100 dark:hover:bg-primary-700/60 transition-colors">Become a member!</a>
  </div>
</div>

<!-- Modal -->
<div class="evt-modal" id="evt-modal-{{ .Get "id" }}" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
  <div class="evt-modal-inner bg-neutral dark:bg-neutral-800 rounded-xl p-5 relative shadow-2xl opacity-100" style="width:min(520px,95vw);">
    <button type="button" class="evt-close bg-transparent border-none text-2xl cursor-pointer text-neutral-700 dark:text-neutral-300" aria-label="Close" style="position:absolute; top:10px; right:10px;">Ã—</button>
    <h3 class="mt-0 mb-3 text-lg font-bold text-neutral-800 dark:text-neutral-200">Ticket Checkout</h3>
    <div class="evt-step evt-details" style="display:block;">
      <label class="block mt-2 mb-1 font-semibold text-neutral-700 dark:text-neutral-300">Full name</label>
      <input type="text" class="evt-name w-full p-2.5 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-neutral dark:bg-neutral-700 text-neutral-800 dark:text-neutral-200" placeholder="Jane Doe">
      <label class="block mt-3 mb-1 font-semibold text-neutral-700 dark:text-neutral-300">Email</label>
      <input type="email" class="evt-email w-full p-2.5 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-neutral dark:bg-neutral-700 text-neutral-800 dark:text-neutral-200" placeholder="you@example.com">
      <div class="mt-3 flex gap-2 items-start text-sm leading-tight">
        <input type="checkbox" class="evt-privacy mt-1">
        <label class="text-neutral-700 dark:text-neutral-300">I agree to the <a href="/privacy-policy/" target="_blank" rel="noopener" class="text-primary-600 dark:text-primary-400 underline">Privacy Policy</a>.</label>
      </div>
      <div class="mt-3">
        <div class="text-sm text-neutral-700 dark:text-neutral-300 mb-2">Security check</div>
        <div id="evt-ts-{{ .Get "id" }}" data-sitekey="{{ .Get "sitekey" | default "0x4AAAAAACAB4xlOnW3S8K0k" }}" data-size="flexible"></div>
      </div>
      <button type="button" class="evt-continue mt-4 w-full py-3 border-none rounded-lg bg-primary-600 dark:bg-primary-500 text-neutral-50 font-bold cursor-pointer hover:bg-primary-700 dark:hover:bg-primary-600 transition-colors">Continue to Payment</button>
    </div>
    <div id="evt-card-{{ .Get "id" }}" class="evt-card mt-2" style="display:none;"></div>
    <div class="evt-error mt-2.5 text-sm font-semibold" style="display:none; color:#b00020;"></div>
    <div class="evt-success mt-4 py-3 px-4 rounded-lg font-semibold" style="display:none; background:#e9fbe9; border:1px solid #b9e8b9; color:#1a5d1a;">Ticket confirmed! See you there.</div>
  </div>
</div>

<script>
(function(){
  const API_BASE = (window.__DB_API_BASE || 'https://dicebastion-memberships.ncalamaro.workers.dev').replace(/\/+$/,'');
  const eventId = '{{ .Get "id" }}';
  const TS_SITE_KEY = '{{ .Get "sitekey" | default "0x4AAAAAACAB4xlOnW3S8K0k" }}';
  const IS_LOCALHOST = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  if(!eventId) return;

  const root = document.querySelector('.event-purchase[data-event-id="'+eventId+'"]');
  const memberPriceEl = document.getElementById('evt-member-price-'+eventId);
  const nonMemberPriceEl = document.getElementById('evt-nonmember-price-'+eventId);
  const modal = document.getElementById('evt-modal-'+eventId);
  const cardEl = document.getElementById('evt-card-'+eventId);
  
  let currentEvent = null;
  let hasActiveMembership = false;
  let userApplicablePrice = null;

  function showError(msg){
    const el = modal && modal.querySelector('.evt-error');
    if(!el) return; el.textContent = msg || 'Error'; el.style.display='block';
  }
  function clearError(){ const el = modal && modal.querySelector('.evt-error'); if(el){ el.textContent=''; el.style.display='none'; } }
  function showSuccess(emailSent = true){ 
    const el = modal && modal.querySelector('.evt-success'); 
    if(!el) return;
    if (!emailSent) {
      const note = document.createElement('p');
      note.style.cssText = 'margin-top:0.75rem;font-size:0.9em;color:#f59e0b;';
      note.textContent = 'Note: Your confirmation email is being processed and will arrive shortly.';
      el.appendChild(note);
    }
    el.style.display='block';
  }
  
  function showPending(){
    const el = modal && modal.querySelector('.evt-success');
    if(!el) return;
    el.innerHTML = '<div style="text-align:center;"><h3>ðŸŽ‰ Payment Received!</h3><p>Your payment is being processed. You\'ll receive a confirmation email shortly.</p><p style="margin-top:1rem;font-size:0.9em;color:#666;">You can safely close this window.</p></div>';
    el.style.display='block';
  }

  async function loadEvent(){
    try {
      // Check if user has active membership
      const sessionToken = localStorage.getItem('admin_session');
      if (sessionToken) {
        try {
          const accountResp = await fetch(API_BASE + '/account/info', {
            headers: { 'X-Session-Token': sessionToken }
          });
          if (accountResp.ok) {
            const accountData = await accountResp.json();
            hasActiveMembership = accountData.membership !== null && accountData.membership !== undefined;
            console.log('[eventPurchase] Membership check:', { 
              hasMembership: hasActiveMembership, 
              email: accountData.user?.email,
              membershipData: accountData.membership 
            });
          } else {
            const errorData = await accountResp.json();
            console.log('[eventPurchase] Account info failed:', accountResp.status, errorData);
          }
        } catch (e) {
          console.log('[eventPurchase] Could not check membership status:', e);
        }
      } else {
        console.log('[eventPurchase] No session token found');
      }
      
      const r = await fetch(API_BASE + '/events/' + encodeURIComponent(eventId));
      const j = await r.json();
      if(!r.ok || !j.event){ showError('Event not found'); return; }
      const ev = j.event;
      currentEvent = ev;
      
      const sym = (c) => ({ GBP:'Â£', EUR:'â‚¬', USD:'$' }[String(c||'').toUpperCase()] || '');
      const formatPrice = (price, currency) => {
        const numPrice = Number(price || 0);
        return numPrice === 0 ? 'FREE' : sym(currency) + numPrice.toFixed(2);
      };
      if(memberPriceEl) memberPriceEl.textContent = formatPrice(ev.membership_price, 'GBP');
      if(nonMemberPriceEl) nonMemberPriceEl.textContent = formatPrice(ev.non_membership_price, 'GBP');
      
      // Determine applicable price for this user
      userApplicablePrice = hasActiveMembership ? Number(ev.membership_price || 0) : Number(ev.non_membership_price || 0);
      
      // Update button text based on price
      const buyBtn = root && root.querySelector('.evt-buy-btn');
      if (buyBtn && userApplicablePrice === 0) {
        buyBtn.textContent = 'Register for Free';
      }
    } catch(e){ showError('Failed loading event'); }
  }

  async function getTurnstileToken(){
    return await window.utils.getTurnstileToken('evt-ts-' + eventId, null, false);
  }

  async function confirm(ref, pollOptions = {}){
    const result = await window.utils.pollPaymentConfirmation('/events/confirm', ref, {
      pollInterval: pollOptions.pollInterval,
      maxAttempts: pollOptions.maxAttempts,
      onSuccess: (data) => {
        if (data.needsAccountSetup && data.userEmail) {
          sessionStorage.setItem('pendingAccountSetup', JSON.stringify({
            email: data.userEmail,
            eventName: data.eventName || 'this event'
          }));
        }
        if (!data.emailSent) {
          console.warn('[shortcode] Payment succeeded but email failed. User:', data.userEmail);
        }
        // Redirect to thank-you page with event details
        window.location.href = '/thank-you?orderRef=' + encodeURIComponent(ref) + 
          (data.emailSent === false ? '&emailPending=1' : '');
      },
      onError: (errorMsg) => {
        showError(errorMsg);
      },
      onTimeout: () => {
        // Redirect to thank-you with processing flag
        window.location.href = '/thank-you?orderRef=' + encodeURIComponent(ref) + '&processing=1';
      }
    });
    return result !== null;
  }

  async function mountWidget(checkoutId, orderRef){
    try { await window.utils.loadSumUpSdk(); } catch(e){ showError('Payment widget failed.'); return; }
    try {
      clearError();
      cardEl.style.display='block';
      modal.querySelector('.evt-details').style.display='none';
      cardEl.innerHTML='';
      window.SumUpCard.mount({ id: 'evt-card-'+eventId, checkoutId, onResponse: async (type) => {
        // Clear any previous errors
        clearError();
        const t = String(type||'').toLowerCase();
        if (t === 'success') {
          await confirm(orderRef, { pollInterval: 3000, maxAttempts: 20 });
        } else if (t === 'error' || t === 'fail') {
          showError('Payment failed. Please try again.');
        } else if (t === 'cancel') {
          showError('Payment cancelled.');
        }
      }});
    } catch(e){ showError('Could not start payment'); }
  }

  function newIdempotencyKey(){ try { return crypto.randomUUID(); } catch { return String(Date.now()) + '-' + Math.random().toString(36).slice(2); } }

  async function startCheckout(email,name,privacy,turnstileToken){
    clearError();
    
    // If user's applicable price is 0, use free registration endpoint
    if (userApplicablePrice === 0) {
      let resp;
      try {
        resp = await fetch(API_BASE + '/events/' + encodeURIComponent(eventId) + '/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, name, turnstileToken })
        });
      } catch(e) {
        showError('Network error');
        return;
      }
      
      const data = await resp.json();
      if (!resp.ok) {
        showError(data?.message || data?.error || 'Registration failed');
        return;
      }
      
      // Show success and redirect
      if (data.success) {
        showSuccess(true);
        setTimeout(() => {
          window.location.href = '/thank-you?event=' + encodeURIComponent(currentEvent.title || 'Event');
        }, 2000);
      }
      return;
    }
    
    // Otherwise, use paid checkout flow
    let resp; try {
      resp = await fetch(API_BASE + '/events/' + encodeURIComponent(eventId) + '/checkout', { method:'POST', headers:{'Content-Type':'application/json','Idempotency-Key': newIdempotencyKey() }, body: JSON.stringify({ email, name, privacyConsent: privacy, turnstileToken }) });
    } catch(e){ showError('Network error'); return; }
    const data = await resp.json();
    if(!resp.ok){ showError(data?.message || data?.error || 'Checkout failed'); return; }
    if(data.checkoutId){ mountWidget(data.checkoutId, data.orderRef); return; }
    showError('Missing checkout ID');
  }

  function openModal(){ if(modal){ modal.style.display='flex'; const nameInput = modal.querySelector('.evt-name'); if(nameInput) nameInput.focus(); window.utils.loadTurnstileSdk().catch(()=>{}); } }
  function closeModal(){ if(modal){ modal.style.display='none'; const d = modal.querySelector('.evt-details'); if(d) d.style.display='block'; if(cardEl){ cardEl.innerHTML=''; cardEl.style.display='none'; } clearError(); const s=modal.querySelector('.evt-success'); if(s) s.style.display='none'; modal.querySelector('.evt-name').value=''; modal.querySelector('.evt-email').value=''; modal.querySelector('.evt-privacy').checked=false; window.utils.cleanupTurnstile(null, 'evt-ts-'+eventId); } }

  root && root.querySelector('.evt-buy-btn')?.addEventListener('click', async () => { openModal(); });
  modal && modal.querySelector('.evt-close')?.addEventListener('click', closeModal);

  const contBtn = modal && modal.querySelector('.evt-continue');
  contBtn && contBtn.addEventListener('click', async () => {
    const name = modal.querySelector('.evt-name').value.trim();
    const email = modal.querySelector('.evt-email').value.trim();
    const privacy = modal.querySelector('.evt-privacy').checked;
    if(!name){ showError('Enter your full name'); return; }
    if(!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){ showError('Enter a valid email'); return; }
    if(!privacy){ showError('Please agree to the Privacy Policy'); return; }
    clearError();
    contBtn.disabled = true;
    let token; try { token = await getTurnstileToken(); } catch(e){ showError(e.message || 'Security check failed.'); contBtn.disabled = false; return; }
    contBtn.disabled = false;
    startCheckout(email,name,privacy,token);
  });

  ['input','change'].forEach(ev => {
    ['.evt-name','.evt-email','.evt-privacy'].forEach(sel => {
      const el = modal && modal.querySelector(sel); if(el) el.addEventListener(ev, clearError);
    });
  });

  const qs = new URLSearchParams(location.search); const ref = qs.get('orderRef');
  if(ref){ confirm(ref).then(()=>{ const u=new URL(location.href); u.searchParams.delete('orderRef'); history.replaceState({},'',u); }); }

  // Render Turnstile programmatically when modal opens
  const buyBtn = root && root.querySelector('.evt-buy-btn');
  if (buyBtn) {
    buyBtn.addEventListener('click', () => {
      if (modal) {
        modal.style.display = 'flex';
        // Render Turnstile after a short delay to ensure modal is visible
        setTimeout(() => {
          window.utils.renderTurnstile('evt-ts-' + eventId, TS_SITE_KEY, { skipOnLocalhost: IS_LOCALHOST });
        }, 100);
      }
    });
  }

  loadEvent();
})();
</script>
