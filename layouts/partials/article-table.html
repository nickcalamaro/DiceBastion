{{/* article-table.html — expects a slice of Pages */}}

{{/* Collect pages with a valid display date (from fuzzy-date partial) */}}
{{ $pagesWithDate := slice }}
{{ range . }}
  {{ $displayDate := partial "functions/fuzzy-date.html" . }}
  {{ if $displayDate }}
    {{ $pagesWithDate = $pagesWithDate | append (dict "Page" . "DisplayDate" $displayDate) }}
  {{ end }}
{{ end }}

{{/* Sort by display date */}}
{{ $sortedPages := sort $pagesWithDate "DisplayDate" }}
{{ $topPages := first 4 $sortedPages }}

{{ if gt (len $topPages) 0 }}
<div class="events-exportable" style="margin-top: 2rem;">
  <button id="export-top5" type="button">Download Top 5 (PNG)</button>

  <table id="events-table" style="
    width: 100%;
    border-collapse: collapse;
    border: 2px solid #ccc;
    border-radius: 4px;
    overflow: hidden;
    table-layout: fixed;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  ">
    <thead>
      <tr style="border-bottom: 2px solid #ccc;">
        <th style="width: 5%; background: #000;"></th>
        <th style="width: 30%; padding: 0.5rem; text-align: center;">Date</th>
        <th style="width: 70%; padding: 0.5rem; text-align: left;">Image</th>
        <th style="width: 5%; background: #000;"></th>
      </tr>
    </thead>
    <tbody>
      {{ range $i, $event := $topPages }}
        {{ $page := $event.Page }}
        {{ $img := $page.Resources.GetMatch "featured*" }}
        {{ $displayDate := $event.DisplayDate }}
        <tr style="background: #000;">
          <td style="background: #000;"></td>
          <td style="padding: 10px; text-align: center; height: 150px;">
            <div class="date-cell" style="
              display: flex;
              flex-direction: column;
              align-items: flex-start;
              justify-content: center;
              height: 100%;
              font-size: 3rem; 
              font-weight: 700;
              text-align: center;
              white-space: normal;
              word-wrap: break-word;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
              letter-spacing: 0px;
              line-height: 1.2;
              color: #fff;
            ">
              {{ $date := $displayDate }}
              {{ $day := $date | time.Format "2" | int }}
              {{ $suffix := "th" }}
              {{ if or (eq (mod $day 100) 11) (eq (mod $day 100) 12) (eq (mod $day 100) 13) }}
                {{ $suffix = "th" }}
              {{ else if eq (mod $day 10) 1 }}
                {{ $suffix = "st" }}
              {{ else if eq (mod $day 10) 2 }}
                {{ $suffix = "nd" }}
              {{ else if eq (mod $day 10) 3 }}
                {{ $suffix = "rd" }}
              {{ end }}
              {{ $date | time.Format "Monday" }} {{ $day }}{{ $suffix }} {{ $date | time.Format "Jan" }}
            </div>
          </td>
          <td style="vertical-align: top;">
            {{ if $img }}
              <img 
                src="{{ $img.RelPermalink }}" 
                alt="Featured image for {{ $page.Title }}" 
                style="
                  width: 100%;
                  aspect-ratio: 1900/664;
                  object-fit: cover;
                  display: block;
                "
              />
            {{ else }}
              <span style="color: #999;">No image</span>
            {{ end }}
          </td>
          <td style="background: #000;"></td>
        </tr>
        {{ if lt $i (sub (len $topPages) 1) }}
          <tr style="height: 2px; background: #000;"></tr>
        {{ end }}
      {{ end }}
    </tbody>
  </table>
</div>

<script>
(function() {
  // Split "Saturday 18th October" → ["Saturday", "18th Oct"]
  function splitDate(text) {
    const parts = text.trim().split(" ");
    if (parts.length < 3) return [text];
    const day = parts[0];              // Saturday
    const num = parts[1];              // 18th
    const month = parts[2].slice(0,3); // Oct
    return [day, `${num} ${month}`];
  }

  function exportTopRowsAsImage({
    tableSelector = '#events-table',
    filename = 'events-top4-gradient',
    type = 'png',
    quality = 1,
    rows = 4, 
    scale = 2,
    totalWidth = 1200
  } = {}) {
    const rowHeight = 150;
    const headerHeight = 100;
    const totalHeight = rows * (rowHeight) + headerHeight;
    const table = document.querySelector(tableSelector);
    if (!table) return;

    const clone = table.cloneNode(true);
    clone.querySelectorAll('thead').forEach(thead => thead.remove());

    Array.from(clone.tBodies).forEach(tbody => {
      const trs = Array.from(tbody.rows);
      trs.slice(rows * 2).forEach(tr => tr.remove()); // account for spacer rows
    });

    // Wrap and center dates
    clone.querySelectorAll('tbody tr td:first-child div').forEach(div => {
      const [day, rest] = splitDate(div.textContent);
      div.innerHTML = `<span>${day}</span><span style="margin-top:0.3em">${rest}</span>`;
      div.style.display = 'flex';
      div.style.flexDirection = 'column';
      div.style.alignItems = 'flex-start';
      div.style.justifyContent = 'center';
      div.style.height = '100%';
      div.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
      div.style.fontSize = '3rem';
      div.style.fontWeight = '700';
      div.style.letterSpacing = '0px';
      div.style.lineHeight = '1.2';
    });

    clone.style.cssText = `
      width: ${totalWidth}px;
      table-layout: fixed;
      margin: 0;
      border-spacing: 0;
      border-collapse: collapse;
      border: 2px solid #333;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    `;


    // Move container.appendChild(clone) and document.body.appendChild(container) before bgImg.onload
    const container = document.createElement('div');
    container.style.cssText = `
      position: fixed;
      left: -99999px;
      top: 0;
      width: ${totalWidth}px;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    `;
    container.appendChild(clone);
    document.body.appendChild(container);

    const bgImg = new window.Image();
    bgImg.src = '/img/table-background.png';
    bgImg.onload = function() {
      // Scale down the table and center it on the background
      const scaleFactor = 0.75;
      const tableWidth = Math.floor(totalWidth);
      const tableHeight = Math.floor(clone.offsetHeight * scaleFactor);
      const offsetX = 0;
      const offsetY = Math.floor((bgImg.height - tableHeight) / 2);

      document.fonts.ready.then(() => {
        html2canvas(container, {
          backgroundColor: null,
          scale: 0.7, // scale down the table by 70%
          useCORS: true,
          width: clone.offsetWidth // use the actual table width
        }).then(canvas => {
          const bgCanvas = document.createElement('canvas');
          bgCanvas.width = 1000;
          bgCanvas.height = 1200;
          const ctx = bgCanvas.getContext('2d');
          ctx.drawImage(bgImg, 0, 0, bgCanvas.width, bgCanvas.height);
          // Center the scaled table image on the background
          const offsetX = Math.floor((bgCanvas.width - canvas.width) / 2);
          const offsetY = Math.floor((bgCanvas.height - canvas.height) / 2);
          ctx.drawImage(canvas, offsetX, offsetY);
          bgCanvas.toBlob(blob => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${filename}.${type}`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
            container.remove();
          }, `image/${type}`, quality);
        }).catch(err => {
          console.error('Export failed:', err);
          container.remove();
        });
      });
    };
  }

  window.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('export-top5');
    if (btn) {
      btn.addEventListener('click', () => {
        exportTopRowsAsImage();
      });
    }
  });
})();
</script>
{{ else }}
  <p>No events found.</p>
{{ end }}
