{{/* article-table.html — expects a slice of Pages */}}

{{ $validPages := where . "Date" "ne" (time "0001-01-01") }}
{{ $sortedPages := sort $validPages "Date" }}
{{ $pages := first 5 $sortedPages }}

{{ if gt (len $pages) 0 }}
<div class="events-exportable" style="margin-top: 2rem;">
  <button id="export-top5" type="button">Download Top 5 (PNG)</button>

  <table id="events-table" style="
    width: 100%;
    border-collapse: collapse;
    border: 2px solid #ccc;
    border-radius: 4px;
    overflow: hidden;
    table-layout: fixed;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  ">
    <thead>
      <tr style="border-bottom: 2px solid #ccc;">
        <th style="width: 70%; padding: 0.5rem; text-align: left;">Image</th>
        <th style="width: 30%; padding: 0.5rem; text-align: center;">Date</th>
      </tr>
    </thead>
    <tbody>
      {{ range $pages }}
        {{ $img := .Resources.GetMatch "featured*" }}
        {{ $displayDate := partial "functions/eventDisplayDate.html" . }}

        <tr>
          <td style="vertical-align: top;">
            {{ if $img }}
              <img 
                src="{{ $img.RelPermalink }}" 
                alt="Featured image for {{ .Title }}" 
                style="
                  width: 100%;
                  aspect-ratio: 1900/664;
                  object-fit: cover;
                  display: block;
                "
              />
            {{ else }}
              <span style="color: #999;">No image</span>
            {{ end }}
          </td>
          <td style="padding: 10px; text-align: center; height: 150px;">
            <div class="date-cell" style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 100%;
              font-size: 3rem; 
              font-weight: 700;
              text-align: center;
              white-space: normal;
              word-wrap: break-word;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
              letter-spacing: 0px;
              line-height: 1.2;
            ">
              {{ $displayDate }}
            </div>
          </td>
        </tr>
      {{ end }}
    </tbody>
  </table>
</div>

<script>
(function() {
  // Split "Saturday 18th October" → ["Saturday", "18th Oct"]
  function splitDate(text) {
    const parts = text.trim().split(" ");
    if (parts.length < 3) return [text];
    const day = parts[0];              // Saturday
    const num = parts[1];              // 18th
    const month = parts[2].slice(0,3); // Oct
    return [day, `${num} ${month}`];
  }

  function exportTopRowsAsImage({
    tableSelector = '#events-table',
    filename = 'events-top5-gradient',
    type = 'png',
    quality = 0.95,
    rows = 5,
    scale = 2,
    totalWidth = 1200 // fixed width, height grows with rows
  } = {}) {
    const table = document.querySelector(tableSelector);
    if (!table) return;

    const clone = table.cloneNode(true);
    clone.querySelectorAll('thead').forEach(thead => thead.remove());

    Array.from(clone.tBodies).forEach(tbody => {
      const trs = Array.from(tbody.rows);
      trs.slice(rows).forEach(tr => tr.remove());
    });

    // Wrap and center dates
    clone.querySelectorAll('tbody tr td:last-child div').forEach(div => {
      const [day, rest] = splitDate(div.textContent);
      div.innerHTML = `<span>${day}</span><span style="margin-top:0.3em">${rest}</span>`;
      div.style.display = 'flex';
      div.style.flexDirection = 'column';
      div.style.alignItems = 'center';
      div.style.justifyContent = 'center';
      div.style.height = '100%';
      div.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
      div.style.fontSize = '3rem';
      div.style.fontWeight = '700';
      div.style.letterSpacing = '0px';
      div.style.lineHeight = '1.2';
    });

    clone.style.cssText = `
      width: ${totalWidth}px;
      table-layout: fixed;
      margin: 0;
      border-spacing: 0;
      border-collapse: collapse;
      border: 2px solid #333;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    `;

    // Apply 70% / 30% widths
    const imgWidth = Math.floor(totalWidth * 0.7);
    const dateWidth = totalWidth - imgWidth;
    clone.querySelectorAll('tr').forEach(tr => {
      const cells = tr.querySelectorAll('th, td');
      if (cells.length === 2) {
        cells[0].style.width = imgWidth + 'px';
        cells[1].style.width = dateWidth + 'px';
      }
    });

    const container = document.createElement('div');
    container.style.cssText = `
      position: fixed;
      left: -99999px;
      top: 0;
      width: ${totalWidth}px;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    `;
    container.appendChild(clone);
    document.body.appendChild(container);

    document.fonts.ready.then(() => {
      html2canvas(container, {
        backgroundColor: null,
        scale,
        useCORS: true,
        width: totalWidth
        // height left dynamic → captures full table
      }).then(canvas => {
        const gradientCanvas = document.createElement('canvas');
        gradientCanvas.width = canvas.width;
        gradientCanvas.height = canvas.height;
        const ctx = gradientCanvas.getContext('2d');

        const gradient = ctx.createLinearGradient(0, 0, gradientCanvas.width, gradientCanvas.height);
        gradient.addColorStop(0.0, '#1e3c72');
        gradient.addColorStop(0.35, '#1e3c72');
        gradient.addColorStop(0.45, '#24497f');
        gradient.addColorStop(0.55, '#2a5298');
        gradient.addColorStop(0.7,  '#3b7fc4');
        gradient.addColorStop(0.85, '#4fa9e6');
        gradient.addColorStop(1.0, '#00c6ff');

        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, gradientCanvas.width, gradientCanvas.height);

        ctx.drawImage(canvas, 0, 0);

        gradientCanvas.toBlob(blob => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${filename}.${type}`;
          document.body.appendChild(a);
          a.click();
          URL.revokeObjectURL(a.href);
          a.remove();
          container.remove();
        }, `image/${type}`, quality);
      }).catch(err => {
        console.error('Export failed:', err);
        container.remove();
      });
    });
  }

  window.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('export-top5');
    if (btn) {
      btn.addEventListener('click', () => {
        exportTopRowsAsImage();
      });
    }
  });
})();
</script>
{{ else }}
  <p>No events found.</p>
{{ end }}
