<!-- Event Detail Modal -->
<div id="event-modal" class="event-modal">
  <div class="event-modal-backdrop" onclick="closeEventModal()"></div>
  <div class="event-modal-content">
    <button class="event-modal-close" onclick="closeEventModal()" aria-label="Close modal">&times;</button>
    <div id="event-modal-body"></div>
  </div>
</div>

<style>
/* Modal Styles */
.event-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.event-modal * {
  text-decoration: none !important;
}

.event-modal a:hover {
  text-decoration: underline !important;
}

.event-modal.is-open {
  display: flex;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.event-modal-backdrop {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(4px);
  cursor: pointer;
}

.event-modal-content {
  position: relative;
  background: rgb(var(--color-neutral));
  border-radius: 16px;
  max-width: 900px;
  max-height: 90vh;
  width: 100%;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  z-index: 1;
  animation: slideUp 0.3s ease;
}

.dark .event-modal-content {
  background: rgb(var(--color-neutral-800));
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.event-modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: rgb(var(--color-neutral-200));
  border: none;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  font-size: 32px;
  line-height: 1;
  cursor: pointer;
  color: rgb(var(--color-neutral-700));
  transition: all 0.2s;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.event-modal-close:hover {
  background: rgb(var(--color-neutral-300));
  color: rgb(var(--color-neutral-900));
  transform: rotate(90deg);
}

.dark .event-modal-close {
  background: rgb(var(--color-neutral-700));
  color: rgb(var(--color-neutral-200));
}

.dark .event-modal-close:hover {
  background: rgb(var(--color-neutral-600));
  color: rgb(var(--color-neutral-100));
}

.event-detail-hero {
  width: 100%;
  height: 300px;
  margin: 0 0 1.5rem 0;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.event-detail-hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: var(--modal-bg-image);
  background-size: cover;
  background-position: center;
  filter: blur(60px) brightness(0.9);
  transform: scale(1.2);
  z-index: 0;
  opacity: 0.95;
}

.dark .event-detail-hero::before {
  filter: blur(60px) brightness(0.7);
}

.event-detail-hero img {
  width: auto;
  height: 100%;
  display: block;
  position: relative;
  z-index: 1;
}

.event-detail-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 4rem 1.5rem 0 !important;
  padding: 0 !important;
  color: rgb(var(--color-neutral-900));
  line-height: 1.2;
}

.dark .event-detail-title {
  color: rgb(var(--color-neutral-100));
}

.event-detail-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  margin: 2rem 0;
  padding: 1.5rem;
  background: rgb(var(--color-neutral-100));
  border-radius: 12px;
  border: 1px solid rgb(var(--color-neutral-200));
}

.dark .event-detail-meta {
  background: rgb(var(--color-neutral-700));
  border-color: rgb(var(--color-neutral-600));
}

.event-detail-meta-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: rgb(var(--color-neutral-700));
  font-size: 1rem;
}

.dark .event-detail-meta-item {
  color: rgb(var(--color-neutral-300));
}

.event-detail-meta-item strong {
  color: rgb(var(--color-neutral-900));
  font-weight: 600;
}

.dark .event-detail-meta-item strong {
  color: rgb(var(--color-neutral-100));
}

.event-detail-description {
  line-height: 1.8;
  color: rgb(var(--color-neutral-700));
  margin: 2rem 0;
  font-size: 1.0625rem;
}

.dark .event-detail-description {
  color: rgb(var(--color-neutral-300));
}

.event-detail-description h1,
.event-detail-description h2,
.event-detail-description h3 {
  color: rgb(var(--color-neutral-900));
  margin-top: 2rem;
  margin-bottom: 1rem;
  font-weight: 700;
}

.dark .event-detail-description h1,
.dark .event-detail-description h2,
.dark .event-detail-description h3 {
  color: rgb(var(--color-neutral-100));
}

.event-detail-description h1 { font-size: 2rem; }
.event-detail-description h2 { font-size: 1.5rem; }
.event-detail-description h3 { font-size: 1.25rem; }
.event-detail-description p { margin: 1rem 0; }

.event-detail-description ul,
.event-detail-description ol {
  margin: 1rem 0;
  padding-left: 2rem;
}

.event-detail-description li { margin: 0.5rem 0; }

.event-detail-description a {
  color: rgb(var(--color-primary-600));
  transition: color 0.2s;
}

.event-detail-description a:hover {
  color: rgb(var(--color-primary-700));
}

.dark .event-detail-description a {
  color: rgb(var(--color-primary-400));
}

.dark .event-detail-description a:hover {
  color: rgb(var(--color-primary-300));
}

.event-detail-description strong,
.event-detail-description b {
  font-weight: 600;
  color: rgb(var(--color-neutral-800));
}

.dark .event-detail-description strong,
.dark .event-detail-description b {
  color: rgb(var(--color-neutral-200));
}

@media (max-width: 768px) {
  .event-modal {
    padding: 0.5rem;
  }
  
  .event-modal-content {
    max-height: 95vh;
    border-radius: 12px;
  }
  
  .event-detail-hero {
    width: calc(100% + 3rem);
    height: 200px;
    margin: -1rem -1.5rem 1.5rem -1.5rem;
  }
  
  .event-detail-hero img {
    max-height: 180px;
  }
  
  .event-detail-title {
    font-size: 1.75rem;
  }
  
  .event-detail-meta {
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
  }
  
  .event-detail-description {
    font-size: 1rem;
  }
  
  .event-detail-description h1 { font-size: 1.5rem; }
  .event-detail-description h2 { font-size: 1.25rem; }
  .event-detail-description h3 { font-size: 1.125rem; }
}
</style>

<script src="/js/eventPurchase.js"></script>

<script>
function openEventModal(eventId, allEvents) {
  const event = allEvents.find(e => e.id === eventId);
  if (!event) return;
  
  const datetime = new Date(event.event_datetime);
  const isFree = event.requires_purchase !== 1;
  
  const dateStr = formatEventDate(datetime);
  const timeStr = datetime.toLocaleTimeString('en-GB', { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  
  let html = '';
  
  if (event.image_url) {
    html += `<div class="event-detail-hero" style="--modal-bg-image: url('${event.image_url}');">
      <img src="${event.image_url}" alt="${event.title}">
    </div>`;
  }
  
  html += '<div style="padding: 1.5rem 3rem 3rem 3rem;">';
  html += `<h1 class="event-detail-title">${event.title}`;
  if (isFree) html += '<span class="free-badge">Free Event</span>';
  html += '</h1>';
  
  html += '<div class="event-detail-meta">';
  html += `<div class="event-detail-meta-item"><strong>üìÖ Date:</strong> ${dateStr}</div>`;
  html += `<div class="event-detail-meta-item"><strong>üïí Time:</strong> ${timeStr}</div>`;
  if (event.location) {
    html += `<div class="event-detail-meta-item"><strong>üìç Location:</strong> ${event.location}</div>`;
  }
  if (!isFree && event.capacity) {
    const available = event.capacity - (event.tickets_sold || 0);
    html += `<div class="event-detail-meta-item"><strong>üé´ Spots:</strong> ${available} / ${event.capacity}</div>`;
  }
  html += '</div>';
    if (event.full_description) {
    html += `<div class="event-detail-description">${event.full_description}</div>`;
  } else if (event.description) {
    html += `<div class="event-detail-description"><p>${event.description}</p></div>`;
  }
  
  if (typeof renderEventPurchase === 'function') {
    html += renderEventPurchase(event);
  }
  
  html += '</div>';
    document.getElementById('event-modal-body').innerHTML = html;
  document.getElementById('event-modal').classList.add('is-open');
  document.body.style.overflow = 'hidden';
  
  // Use setTimeout to ensure DOM has fully updated before attaching event listeners
  setTimeout(() => {
    if (typeof initEventPurchase === 'function') {
      initEventPurchase(event);
    }
  }, 0);
}

function closeEventModal() {
  document.getElementById('event-modal').classList.remove('is-open');
  document.body.style.overflow = '';
}

function formatEventDate(datetime) {
  const weekday = datetime.toLocaleDateString('en-GB', { weekday: 'long' });
  const day = datetime.getDate();
  const month = datetime.toLocaleDateString('en-GB', { month: 'long' });
  const suffix = day > 3 && day < 21 ? 'th' : ['th', 'st', 'nd', 'rd'][day % 10] || 'th';
  return `${weekday} ${day}${suffix} ${month}`;
}

// Close on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeEventModal();
});
</script>
